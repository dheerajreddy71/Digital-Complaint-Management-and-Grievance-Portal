# API Routes Documentation

## Base URL
```
http://localhost:3000/api
```

## Authentication

All protected routes require a Bearer token in the Authorization header:
```
Authorization: Bearer <access_token>
```

---

## Auth Endpoints

### POST /auth/register
Register a new user account.

**Request Body:**
```json
{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "SecurePass123!",
  "phone": "+1234567890"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "Registration successful",
  "data": {
    "user": {
      "id": 1,
      "name": "John Doe",
      "email": "john@example.com",
      "role": "citizen"
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "dGhpcyBpcyBhIHJlZnJl..."
  }
}
```

### POST /auth/login
Authenticate user and receive tokens.

**Request Body:**
```json
{
  "email": "john@example.com",
  "password": "SecurePass123!"
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "user": { ... },
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "dGhpcyBpcyBhIHJlZnJl..."
  }
}
```

### POST /auth/refresh
Refresh access token using refresh token.

**Request Body:**
```json
{
  "refreshToken": "dGhpcyBpcyBhIHJlZnJl..."
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "bmV3IHJlZnJlc2ggdG9r..."
  }
}
```

### POST /auth/logout
Invalidate refresh token (requires authentication).

**Response (200):**
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

### POST /auth/change-password
Change user password (requires authentication).

**Request Body:**
```json
{
  "currentPassword": "OldPass123!",
  "newPassword": "NewSecurePass456!"
}
```

### GET /auth/me
Get current authenticated user profile.

**Response (200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "John Doe",
    "email": "john@example.com",
    "role": "citizen",
    "phone": "+1234567890",
    "created_at": "2024-01-15T10:30:00.000Z"
  }
}
```

---

## Complaints Endpoints

### GET /complaints
Get complaints list with filters and pagination.

**Query Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| page | number | Page number (default: 1) |
| limit | number | Items per page (default: 10, max: 50) |
| status | string | Filter by status (pending, in_progress, resolved, closed) |
| priority | string | Filter by priority (low, medium, high, critical) |
| category | string | Filter by category |
| search | string | Search in title and description |
| sortBy | string | Sort field (created_at, priority, status) |
| sortOrder | string | Sort order (asc, desc) |

**Response (200):**
```json
{
  "success": true,
  "data": {
    "complaints": [...],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 45,
      "totalPages": 5
    }
  }
}
```

### POST /complaints
Create a new complaint (requires authentication).

**Request Body (multipart/form-data):**
```json
{
  "title": "Street Light Not Working",
  "description": "The street light at Main St and 5th Ave has been out for 2 weeks.",
  "category": "infrastructure",
  "priority": "medium",
  "location": "Main St and 5th Ave",
  "attachments": [File, File]
}
```

**Response (201):**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "tracking_id": "CMP-2024-00123",
    "title": "Street Light Not Working",
    ...
  }
}
```

### GET /complaints/:id
Get complaint details by ID.

**Response (200):**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "tracking_id": "CMP-2024-00123",
    "title": "Street Light Not Working",
    "description": "...",
    "status": "in_progress",
    "priority": "medium",
    "category": "infrastructure",
    "citizen": { "id": 1, "name": "John Doe" },
    "assigned_to": { "id": 5, "name": "Jane Smith" },
    "attachments": ["url1", "url2"],
    "created_at": "2024-01-15T10:30:00.000Z",
    "updated_at": "2024-01-16T14:20:00.000Z",
    "sla_deadline": "2024-01-18T10:30:00.000Z",
    "is_overdue": false
  }
}
```

### PUT /complaints/:id
Update complaint (owner or staff/admin).

**Request Body:**
```json
{
  "title": "Updated Title",
  "description": "Updated description",
  "priority": "high"
}
```

### PATCH /complaints/:id/status
Update complaint status (staff/admin only).

**Request Body:**
```json
{
  "status": "resolved",
  "resolution_notes": "Issue has been fixed. Street light replaced."
}
```

### POST /complaints/:id/assign
Assign complaint to staff (admin only).

**Request Body:**
```json
{
  "staff_id": 5
}
```

### DELETE /complaints/:id
Delete complaint (admin only).

---

## Comments Endpoints

### GET /complaints/:id/comments
Get comments for a complaint.

**Response (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "content": "Thank you for reporting this issue.",
      "author": { "id": 5, "name": "Jane Smith", "role": "staff" },
      "is_internal": false,
      "created_at": "2024-01-16T09:15:00.000Z"
    }
  ]
}
```

### POST /complaints/:id/comments
Add comment to complaint.

**Request Body:**
```json
{
  "content": "We are working on this issue.",
  "is_internal": false
}
```

### DELETE /comments/:id
Delete a comment (owner or admin).

---

## Feedback Endpoints

### POST /complaints/:id/feedback
Submit feedback for resolved complaint (citizen only).

**Request Body:**
```json
{
  "rating": 5,
  "comments": "Great service! Issue was resolved quickly."
}
```

### GET /complaints/:id/feedback
Get feedback for a complaint.

---

## Status History Endpoints

### GET /complaints/:id/history
Get status change history for a complaint.

**Response (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "from_status": null,
      "to_status": "pending",
      "changed_by": { "id": 1, "name": "John Doe" },
      "notes": "Complaint submitted",
      "created_at": "2024-01-15T10:30:00.000Z"
    },
    {
      "id": 2,
      "from_status": "pending",
      "to_status": "in_progress",
      "changed_by": { "id": 5, "name": "Jane Smith" },
      "notes": "Assigned to maintenance team",
      "created_at": "2024-01-16T09:00:00.000Z"
    }
  ]
}
```

---

## Notifications Endpoints

### GET /notifications
Get user notifications.

**Query Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| page | number | Page number |
| limit | number | Items per page |
| unread_only | boolean | Filter unread only |

### PATCH /notifications/:id/read
Mark notification as read.

### POST /notifications/mark-all-read
Mark all notifications as read.

### DELETE /notifications/:id
Delete a notification.

### GET /notifications/unread-count
Get count of unread notifications.

---

## User Management Endpoints (Admin Only)

### GET /users
Get all users with pagination.

**Query Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| page | number | Page number |
| limit | number | Items per page |
| role | string | Filter by role |
| search | string | Search by name/email |

### GET /users/:id
Get user by ID.

### PUT /users/:id
Update user.

**Request Body:**
```json
{
  "name": "Updated Name",
  "role": "staff",
  "is_active": true
}
```

### DELETE /users/:id
Delete/deactivate user.

### GET /users/staff
Get all staff members.

### GET /users/staff/:id/performance
Get staff performance metrics.

---

## Analytics Endpoints (Admin Only)

### GET /analytics/overview
Get dashboard overview statistics.

**Response (200):**
```json
{
  "success": true,
  "data": {
    "total_complaints": 1250,
    "pending": 45,
    "in_progress": 120,
    "resolved": 980,
    "closed": 105,
    "avg_resolution_time": 48.5,
    "sla_compliance_rate": 92.3,
    "overdue_count": 12
  }
}
```

### GET /analytics/trends
Get complaint trends over time.

**Query Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| period | string | day, week, month, year |
| start_date | date | Start date |
| end_date | date | End date |

### GET /analytics/by-category
Get complaints grouped by category.

### GET /analytics/by-priority
Get complaints grouped by priority.

### GET /analytics/staff-performance
Get all staff performance metrics.

### GET /analytics/sla-report
Get SLA compliance report.

---

## System Endpoints

### GET /health
Health check endpoint (no auth required).

**Response (200):**
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "uptime": 86400
}
```

### GET /audit-logs (Admin Only)
Get system audit logs.

**Query Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| page | number | Page number |
| limit | number | Items per page |
| action | string | Filter by action type |
| user_id | number | Filter by user |
| start_date | date | Start date |
| end_date | date | End date |

---

## Error Responses

All endpoints may return the following error formats:

### 400 Bad Request
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": [
    { "field": "email", "message": "Invalid email format" }
  ]
}
```

### 401 Unauthorized
```json
{
  "success": false,
  "message": "Authentication required"
}
```

### 403 Forbidden
```json
{
  "success": false,
  "message": "Insufficient permissions"
}
```

### 404 Not Found
```json
{
  "success": false,
  "message": "Resource not found"
}
```

### 429 Too Many Requests
```json
{
  "success": false,
  "message": "Rate limit exceeded. Please try again later."
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "message": "An unexpected error occurred"
}
```

---

## Rate Limits

| Endpoint Type | Limit |
|---------------|-------|
| Authentication | 5 requests per minute |
| General API | 100 requests per 15 minutes |
| File Upload | 10 requests per hour |

---

## Pagination

All list endpoints support pagination with the following response format:

```json
{
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "totalPages": 10,
    "hasNext": true,
    "hasPrev": false
  }
}
```
